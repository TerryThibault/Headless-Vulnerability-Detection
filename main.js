const puppeteer = require('puppeteer');
		
async function run() {
	var args = process.argv.slice(2);
	target_url = args[0]
	// cookies = args[1].toString()
	// console.log(cookies)
	const browser = await puppeteer.launch(
		{
			headless: false
		});
	const page = await browser.newPage();
	// await page.setCookie(cookies)
	// await page.setCookie({ 
	// 	'name': 'PHPSESSID',
	// 	'domain': '192.168.221.142',
	// 	'path': '/', 
	// 	'last accessed on': 'Wed, 07 Feb 2018 20:38:20 GMT',
	// 	'value': 'n5ut009g7pla6ho77765i1ut12',
	// 	'httponly': 'false'});
	// await crawl(target_url, page)
	await page.goto(target_url)

	// Once we have the number of forms on the page, we can get the number of entry points
	var countEntryPoints = getCountEntryPoints(page)
}

async function crawl(target_url, page) {
	const hostname = await getHostName(target_url)
	await page.goto(target_url)
	var uniq_links = new Set()
	var not_visited_links = Array.from(uniq_links)
	console.log(not_visited_links)
	not_visited_links.push(target_url)
	uniq_links.add(target_url)
	while (not_visited_links.length > 0) {
		const curr_link = not_visited_links.shift()
		console.log('visiting ' + curr_link)
		await page.goto(curr_link)
		
		var links = await page.evaluate(() => {
        	return Array.from(document.querySelectorAll('a')).map(
        		link => link.href
    		);
		});
		links = Array.from(new Set(links))

		links.forEach( function(element) {
			if (!uniq_links.has(element) && isInScope(hostname, element)) {
				uniq_links.add(element)
				not_visited_links.push(element)
				console.log("adding " + element)
			}
		});
	}
	return uniq_links;
}

function getHostName(url) {
    var match = url.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);
    if (match != null && match.length > 2 && typeof match[2] === 'string' && match[2].length > 0) {
    	return match[2];
    }
    else {
        return null;
    }
}

function isInScope(hostname, url) {
	var result = (getHostName(url) == hostname)
	// console.log("result " + result)
	return result
}

async function getNumberOfForms(page) {
	var numberofForms = await page.evaluate(() => {
		return document.forms.length;
	});
	return numberofForms;
}

async function getNumberOfEntryPoints(page, formNumber) {
	console.log(formNumber)
	var numberOfEntryPoints = await page.evaluate((formNumber) => {
		return document.forms[formNumber].length
	}, formNumber);
	return numberOfEntryPoints;
}

async function getCountEntryPoints(page) {
	var numberOfEntryPoints = 0
	var numberOfForms = await getNumberOfForms(page)
	for (var i = 0; i < numberOfForms; i++) {
		var numberOfEntryPoints = numberOfEntryPoints + await getNumberOfEntryPoints(page, i)
	}
	console.log(numberOfEntryPoints);
}

async function editFormValue(page, formNumber, inputNumber, value) {
	
}
run(); 